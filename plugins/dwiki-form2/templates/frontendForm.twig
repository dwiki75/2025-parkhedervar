{# plugins/dwiki-form2/templates/frontendForm.twig #}
<form method="post" action="" accept-charset="UTF-8"
      class="dwiki-form bg-secondary p-6"
      data-dwiki-form="1"
      data-form-key="{{ formKey }}"
      novalidate>
  {{ csrfInput() }}
  {{ actionInput('dwiki-form2/send') }}

  {# --- rejtett: site és form azonosítók a controllernak --- #}
  <input type="hidden" name="siteUid" value="{{ craft.app.sites.currentSite.uid }}">
  <input type="hidden" name="siteHandle" value="{{ craft.app.sites.currentSite.handle }}">
  <input type="hidden" name="formKey" value="{{ formKey }}">

  {# 1) hagyományos honeypot (nincs ID) #}
  <div style="position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;">
    <label>Ne töltse ki ezt a mezőt</label>
    <input type="text" name="company1" tabindex="-1" autocomplete="off">
  </div>

  {# 2) JS-es honeypot (helyben nevezzük át → nincs globális ID) #}
  <div style="position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;">
    <label>Ne töltse ki ezt a mezőt</label>
    <input type="text" data-name="company2" tabindex="-1" autocomplete="off">
  </div>

  <div class="flex justify-between items-center mb-6 w-full">
{% set lang = currentSite.language ?? 'en' %}

<h2 class="text-2xl font-semibold text-white">
  {% if lang == 'es' %}
    Solicita precios y paquetes
  {% else %}
    Request pricing & packages
  {% endif %}
</h2>

<span class="text-sm text-white">
  {% if lang == 'es' %}
    * = obligatorio
  {% else %}
    * = requested
  {% endif %}
</span>

  </div>

  <div class="flex flex-wrap -mx-1.5">
    {% for field in fields %}
      {# név: a label kebab-case változata (a SendController is ezt várja) #}
      {% set name = field.label|kebab %}
      {# rejtett: a látható címke map a levélhez #}
      <input type="hidden" name="_labels[{{ name }}]" value="{{ field.label }}">

      <div class="w-full md:px-1.5 mb-3
        {% if field.width == 'w-1/2' %} md:w-1/2
        {% elseif field.width == 'w-1/3' %} md:w-1/3
        {% elseif field.width == 'w-2/3' %} md:w-2/3
        {% else %} md:w-full
        {% endif %}">

        {# Label mód #}
        {% if not placeholderMode and field.type not in ['checkbox', 'radio', 'static'] %}
          <label class="block font-semibold mb-1 text-white">
            {{ field.label }}{% if field.required %} *{% endif %}
          </label>
        {% endif %}

        {% if placeholderMode %}
          {% set placeholderText = field.placeholder ?: field.label %}
          {% if field.required %}
            {% set placeholderText = placeholderText ~ ' *' %}
          {% endif %}
        {% endif %}

        {# --- opciók normalizálása: JSON tömb VAGY sortördelten tárolt string --- #}
        {% set raw = field.options %}
        {% set opts = [] %}
        {% if raw is iterable %}
          {% set opts = raw %}
        {% else %}
          {% set s = (raw ?? '')|trim %}
          {% if s %}
            {% if s starts with '[' and s ends with ']' %}
              {% set s2 = s|replace({'[':'', ']':'', '\\"':'"', '"':''}) %}
              {% set s2 = s2|replace({', ':'\n', ',':'\n'}) %}
              {% set opts = s2|split('\n') %}
            {% else %}
              {% set s = s|replace({'\r\n':'\n'}) %}
              {% set opts = s|split('\n') %}
            {% endif %}
          {% endif %}
        {% endif %}

{# --- MEZŐTÍPUSOK --- #}

{% if field.type == 'select' %}
  <div class="relative">
    <select
      name="{{ name }}"
      class="w-full box-border p-2 pr-10 bg-black/20 text-white placeholder-white/70 border-none rounded-md appearance-none leading-[1.5rem] {{ field.cssClass ?? '' }}"
      {% if field.required %}required{% endif %}>
      {% if placeholderMode %}
        <option value="" disabled selected>{{ placeholderText }}</option>
      {% endif %}
      {% for option in opts %}
        {% set opt = option|trim %}
        {% if opt %}
          <option value="{{ opt }}">{{ opt }}</option>
        {% endif %}
      {% endfor %}
    </select>
    <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-white"
         xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
    </svg>
  </div>

{% elseif field.type == 'checkbox' %}
  <label class="inline-flex items-center gap-2 text-white {{ field.cssClass ?? '' }}">
    <input type="hidden" name="{{ name }}" value="0">
    <input
      type="checkbox"
      name="{{ name }}"
      value="1"
      {% if field.required %}required{% endif %}>
    <span>{{ field.label }}{% if field.required %} *{% endif %}</span>
  </label>
  <input type="hidden" name="_types[{{ name }}]" value="checkbox">

{% elseif field.type == 'radio' %}
  {% for option in opts %}
    {% set opt = option|trim %}
    {% if opt %}
      <label class="inline-flex items-center space-x-2 text-white {{ field.cssClass ?? '' }}">
        <input type="radio" name="{{ name }}" value="{{ opt }}" {% if field.required %}required{% endif %}>
        <span>{{ opt }}</span>
      </label>
    {% endif %}
  {% endfor %}

{% elseif field.type == 'textarea' %}
  <textarea
    name="{{ name }}"
    rows="4"
    class="w-full box-border p-2 bg-black/20 text-white placeholder-white/70 border-none rounded-md {{ field.cssClass ?? '' }}"
    {% if field.required %}required{% endif %}
    {% if placeholderMode %}placeholder="{{ placeholderText }}"{% endif %}></textarea>

{% elseif field.type == 'static' %}
  <div class="text-white {{ field.cssClass ?? '' }}">
    {{ field.options|raw }}
  </div>

{% elseif field.type == 'date' %}
  {% set today = now|date('Y-m-d') %}
  <div class="relative w-full">
    <input
      type="date"
      name="{{ name }}"
      value="{{ today }}"
      class="w-full p-2 pr-10 sm:pr-2 bg-black/20 text-white placeholder-white/70 border-none rounded-md {{ field.cssClass ?? '' }}"
      {% if field.required %}required{% endif %}>

    {# Mobilos, jobb oldali ikon – nem foglal helyet, nem kattintható #}
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      class="sm:hidden pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 h-5 w-5 text-white"
      fill="none" stroke="currentColor" stroke-width="1.8">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="16" y1="2" x2="16" y2="6"></line>
      <line x1="8"  y1="2" x2="8"  y2="6"></line>
      <line x1="3"  y1="10" x2="21" y2="10"></line>
    </svg>
  </div>





{% else %}
  <input
    type="{{ field.type }}"
    name="{{ name }}"
    class="w-full box-border p-2 bg-black/20 text-white placeholder-white/70 border-none rounded-md {{ field.cssClass ?? '' }}"
    {% if field.required %}required{% endif %}
    {% if placeholderMode %}placeholder="{{ placeholderText }}"{% endif %}>
{% endif %}


      </div>
    {% endfor %}
  </div>

  <div class="mt-4 flex flex-col md:flex-row md:items-start md:gap-4 w-full">
    <button type="submit" class="px-6 py-3 bg-primary text-black font-semibold rounded-full hover:bg-opacity-80 transition">
      {{ lang == 'es' ? 'Enviar' : 'Send' }}
    </button>
  </div>

  {# A fields tömb JSON-ja minden form mellé lokálisan (nem globál) #}
  <script type="application/json" class="dwiki-fields-json">{{ fields|json_encode|raw }}</script>

  {# --- V2 plugin settings a modalhoz (egyszerű, is-defined nélkül) --- #}
  {% set modalTitle   = 'Thank you for your message!' %}
  {% set modalMessage = 'We will contact you shortly' %}

  {% set plugin = craft.app.plugins.getPlugin('dwiki-form2') %}
  {% if plugin %}
    {% set ps = plugin.getSettings() %}
    {% if ps.modalTitle is not empty %}{% set modalTitle = ps.modalTitle %}{% endif %}
    {% if ps.modalMessage is not empty %}{% set modalMessage = ps.modalMessage %}{% endif %}

    {% set siteUid = craft.app.sites.currentSite.uid %}
    {% set i18nMap = ps.i18n ?? {} %}
    {% set S = i18nMap[siteUid] ?? {} %}
    {% if S.modalTitle is not empty %}{% set modalTitle = S.modalTitle %}{% endif %}
    {% if S.modalMessage is not empty %}{% set modalMessage = S.modalMessage %}{% endif %}
  {% endif %}

  {# Modal – példányonként külön, osztály alapú #}
  <div class="dwiki-success-modal fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-md text-center shadow-lg">
      <h3 class="text-xl font-semibold mb-4">{{ modalTitle }}</h3>
      <p class="mb-6">{{ modalMessage }}</p>
      <button type="button" class="dwiki-close-modal bg-primary text-white px-4 py-2 rounded hover:bg-opacity-80">Bezárás</button>
    </div>
  </div>

  {# --- Per-form mini script: csak ehhez a példányhoz köt (nincs globális ID) --- #}
<script>
(function(){
  const form = document.currentScript.closest('form');
  if (!form) return;

  // helyi fields JSON
  let fields = [];
  const jsonEl = form.querySelector('.dwiki-fields-json');
  try { fields = JSON.parse((jsonEl && jsonEl.textContent) || '[]'); } catch(e){ fields = []; }

  // JS honeypot átnevezés (helyi)
  const hp = form.querySelector('input[data-name]');
  if (hp && hp.dataset.name) hp.setAttribute('name', hp.dataset.name);

  const modal = form.querySelector('.dwiki-success-modal');
  const closeBtn = form.querySelector('.dwiki-close-modal');

  // --- Dátum mezők: ha üres, állítsd maira; ikonra kattintva nyisson pickert ---
  const toYMD = (d) => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const da = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${da}`;
  };

  form.querySelectorAll('input[type="date"]').forEach(function(input){
    if (!input.value) {
      input.value = toYMD(new Date());
    }
    const btn = input.parentElement && input.parentElement.querySelector('[data-date-btn]');
    if (btn) {
      btn.addEventListener('click', function(){
        if (typeof input.showPicker === 'function') {
          try { input.showPicker(); return; } catch(e) {}
        }
        input.focus();
      });
    }
  });

  form.addEventListener('submit', function (e) {
    e.preventDefault();

    let firstErrorField = null;
    form.querySelectorAll(".error-message").forEach(el => el.remove());
    form.querySelectorAll(".error-border").forEach(el => el.classList.remove("error-border"));

    fields.forEach(function(f){
      const name = (f.label || '').toLowerCase().replace(/\s+/g, "-");
      const input = form.querySelector(`[name="${name}"]`);
      const isSelect = input && input.tagName === 'SELECT';
      let errors = [];

      if (f.required) {
        if (f.type === "checkbox") {
          const checked = form.querySelectorAll(`[name="${name}"]:checked`).length > 0;
          if (!checked) errors.push("You must check this box.");
        } else if (f.type === "radio") {
          const checked = form.querySelectorAll(`[name="${name}"]:checked`).length > 0;
          if (!checked) errors.push("You must make a selection.");
        } else if (isSelect) {
          if (!input || !input.value || input.value.trim() === "") errors.push("You must choose a value.");
        } else {
          if (!input || !input.value || !input.value.trim()) errors.push("This field is required.");
        }
      }

      if (f.type === "email" && input && input.value && input.value.trim()) {
        const emailPattern = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
        if (!emailPattern.test(input.value.trim())) {
          errors.push("Please enter a valid email address.");
        }
      }

      if (errors.length) {
        const target = input || form.querySelector(`[name="${name}"]`);
        if (target) {
          target.classList.add("error-border");
          const errorDiv = document.createElement("div");
          errorDiv.className = "error-message";
          errorDiv.textContent = errors.join(" ");
          target.insertAdjacentElement("afterend", errorDiv);
          if (!firstErrorField) firstErrorField = target;
        }
      }
    });

    if (firstErrorField) {
      firstErrorField.scrollIntoView({ behavior: "smooth", block: "center" });
      return;
    }

    const fd = new FormData(form);
    const postUrl = form.getAttribute('action') || window.location.href;
    fetch(postUrl, { method: "POST", body: fd })
      .then(function(res){
        if (res.ok) {
          form.reset();
          if (modal) modal.classList.remove("hidden");
          // reset után a dátumokat ismét maira állítjuk
          form.querySelectorAll('input[type="date"]').forEach(function(input){
            if (!input.value) input.value = toYMD(new Date());
          });
        } else {
          console.error('Beküldési hiba', res.status);
        }
      })
      .catch(function(err){ console.error(err); });
  });

  if (closeBtn && modal) {
    closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
  }
})();
</script>

</form>

<style>
  .error-border { border: 2px solid #fff !important; }
  .error-message { color:#fff; font-weight:600; font-size:0.875rem; margin-top:0.25rem; text-shadow:0 0 3px rgba(0,0,0,0.8); }
</style>
