{% extends "_layouts/cp" %}
{% set title = "Dwiki Form 2" %}

{% block content %}

<p style="margin-bottom:10px;font-style:italic;">
    Aktuális nyelv: <strong>{{ craft.app.sites.currentSite.name }}</strong> ({{ craft.app.sites.currentSite.handle }})
</p>

<form id="siteSwitcher" style="margin-bottom:15px;">
    <label for="siteSelect"><strong>Nyelv kiválasztása:</strong></label>
    <select id="siteSelect" name="site" onchange="this.form.submit()" style="margin-left:10px;">
        {% for site in craft.app.sites.getAllSites() %}
            <option value="{{ site.handle }}" {% if site.handle == craft.app.sites.currentSite.handle %}selected{% endif %}>
                {{ site.name }}
            </option>
        {% endfor %}
    </select>

{% if formKey and (currentFormInList is defined) and not currentFormInList %}
  <div id="currentFormHint"
       style="margin-top:10px;padding:10px 12px;border:2px solid #e53935;background:#fff5f5;border-radius:6px;color:#b71c1c;display:flex;align-items:center;gap:8px;">
    <span aria-hidden="true" style="font-size:16px;line-height:1;">⚠️</span>
    <strong>Aktív űrlap:</strong>
    <span style="font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;background:#ffecec;padding:2px 6px;border-radius:4px;">
      {{ formKey }}
    </span>
    <span class="light">— még üres, ezért nincs a listában</span>
  </div>
{% endif %}
</form>

<form id="formSwitcher" method="get" style="margin-bottom:10px;">
    <label for="formKeyInput"><strong>Űrlap azonosító:</strong></label>
    <input
      type="text"
      id="formKeyInput"
      name="formKey"
      value="{{ formKey ?? 'default' }}"
      list="formKeyList"
      style="margin-left:10px;padding:4px 6px;border:1px solid #ccc;border-radius:4px;"
      placeholder="pl. default, contact, offerte, stb.">
    {% if craft.app.sites.currentSite.handle %}
        <input type="hidden" name="site" value="{{ craft.app.sites.currentSite.handle }}">
    {% endif %}
    <button type="submit" id="loadBtn" class="btn submit" style="margin-left:10px;">Új / Betöltés</button>
</form>

{# ------- ÚJ: Jelenlegi űrlap törlése (POST, JS nélkül) ------- #}
<form method="post"
      style="margin:8px 0 16px;"
      onsubmit="return confirm('Biztosan törlöd a(z) “{{ formKey ?? 'default' }}” űrlapot?');">
  {{ csrfInput() }}
  {{ redirectInput(url(craft.app.request.pathInfo, { site: craft.app.sites.currentSite.handle })) }}

  <input type="hidden" name="action" value="dwiki-form2/default/delete-form">
  <input type="hidden" name="formKey" value="{{ formKey ?? 'default' }}">

  <label style="margin-right:10px;">
    <input type="checkbox" name="scope" value="all">
    Törlés minden nyelven (összes site)
  </label>

  <button type="submit" class="btn" style="margin-left:10px;">Űrlap törlése</button>
</form>

<datalist id="formKeyList">
  {% for it in formKeys ?? [] %}
    <option value="{{ it.formKey }}">
  {% endfor %}
</datalist>

{# ▾▾▾ Gyors űrlapválasztó – szerveroldali linkekkel ▾▾▾ #}
{% if (formKeys ?? [])|length %}
  <div id="formKeysPanel"
       data-site-handle="{{ craft.app.sites.currentSite.handle }}"
       class="pane"
       style="margin:8px 0 18px;padding:8px 10px;background:#f8f8f8;border:1px solid #e5e5e5;border-radius:4px;">
    <strong>Gyors űrlapválasztó:</strong>
    <ul style="margin:6px 0 0 18px;list-style:disc;">
      {% for it in formKeys %}
        <li>
          <a
            href="{{ url(craft.app.request.pathInfo, {
              site: craft.app.sites.currentSite.handle,
              formKey: it.formKey
            }) }}"
            title="Betöltés: {{ it.formKey }}"
          >
            {{ it.formKey }} <span class="light">({{ it.count }})</span>
          </a>
        </li>
      {% endfor %}
    </ul>
  </div>
{% else %}
  <div id="formKeysPanel"
       data-site-handle="{{ craft.app.sites.currentSite.handle }}"
       class="pane"
       style="margin:8px 0 18px;padding:8px 10px;background:#f8f8f8;border:1px solid #e5e5e5;border-radius:4px;">
    <strong>Gyors űrlapválasztó:</strong>
    <em>Még nincs egyetlen űrlap sem.</em>
  </div>
{% endif %}



<h1 class="mb-3">Mezők kezelése</h1>

<button id="addFieldBtn" type="button" class="btn submit">+ Új mező</button>

<div style="margin-top:10px;display:flex;align-items:center;gap:10px;">
    <label style="font-weight:bold;">Placeholder mód bekapcsolva:</label>
    <input type="checkbox" id="globalPlaceholderSwitch" style="transform:scale(1.3);"
           {% if placeholderMode %}checked{% endif %}>
</div>

<table class="data fullwidth mt-3" id="fieldsTable">
    <thead>
        <tr>
            <th>Név</th>
            <th>Típus</th>
            <th>Opcók / Szöveg</th>
            <th>Szélesség</th>
            <th>Kötelező</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="fieldsBody">
        <tr><td colspan="6"><em>Betöltés...</em></td></tr>
    </tbody>
</table>

<!-- Új mező felugró -->
<div id="fieldModal" class="modal" style="display:none;width:100%;height:100%;">
    <div class="modal-content" style="background:#fff;max-width:500px;margin:50px auto;padding:20px;border-radius:6px;box-shadow:0 0 20px rgba(0,0,0,0.3);">
        <h2 style="font-weight:bold;font-size:18px;margin-bottom:15px;">Új mező hozzáadása</h2>

        <label style="display:block;margin-bottom:10px;">
            Név:
            <input type="text" id="fieldLabel" style="width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:4px;">
        </label>

        <label style="display:block;margin-bottom:10px;">
            Típus:
            <select id="fieldType" style="width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:4px;">
                <option value="text">Szöveg</option>
                <option value="textarea">Többsoros szöveg</option>
                <option value="static">Csak olvasható szöveg</option>
                <option value="email">E-mail</option>
                <option value="date">Dátum</option>
                <option value="select">Legördülő</option>
                <option value="checkbox">Jelölőnégyzet</option> 
            </select>
        </label>

        <div id="optionsWrapper" style="display:none;margin-bottom:10px;">
            <label style="display:block;margin-bottom:5px;">Opciók:</label>
            <pre id="optionsList" style="background:#f8f8f8;padding:8px;border:1px solid #ccc;border-radius:4px;min-height:50px;"></pre>
            <button type="button" id="addOptionBtn" class="btn" style="margin-top:5px;padding:5px 10px;border:1px solid #ccc;border-radius:4px;background:#f0f0f0;">+ Opció</button>
        </div>

        <label style="display:block;margin-bottom:15px;">
            Szélesség:
            <select id="fieldWidth" style="width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:4px;">
                <option value="w-full">Teljes (w-full)</option>
                <option value="w-1/2">Fél (w-1/2)</option>
                <option value="w-2/3">Kétharmad (w-2/3)</option>
                <option value="w-1/3">Egyharmad (w-1/3)</option>
            </select>
        </label>

        <label style="display:block;margin-bottom:15px;">
            <input type="checkbox" id="fieldRequired"> Kötelező mező
        </label>

        <div style="text-align:right;">
            <button id="saveFieldBtn" type="button" class="btn submit" style="background:#e53935;color:#fff;padding:6px 12px;border:none;border-radius:4px;margin-right:5px;">Mentés</button>
            <button id="cancelFieldBtn" type="button" class="btn" style="background:#ccc;padding:6px 12px;border:none;border-radius:4px;">Mégse</button>
        </div>
    </div>
</div>

<style>
.modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:9999; }
.modal-content { background:#fff; padding:20px; border-radius:5px; width:400px; }
#optionsList input, #optionsList textarea { display:block; margin-bottom:5px; width:100%; }
.moveIcon { margin-right:10px; }
</style>

<script>
console.log("✅ dwiki-form2.js betöltve");

document.addEventListener("DOMContentLoaded", function() {
    const fieldsBody = document.getElementById('fieldsBody');
    const modal = document.getElementById('fieldModal');
    const addBtn = document.getElementById('addFieldBtn');
    const cancelBtn = document.getElementById('cancelFieldBtn');
    const saveBtn = document.getElementById('saveFieldBtn');
    const fieldLabel = document.getElementById('fieldLabel');
    const fieldType = document.getElementById('fieldType');
    const fieldWidth = document.getElementById('fieldWidth');
    const fieldRequired = document.getElementById('fieldRequired');
    const optionsWrapper = document.getElementById('optionsWrapper');
    const optionsList = document.getElementById('optionsList');
    const addOptionBtn = document.getElementById('addOptionBtn');
    const placeholderSwitch = document.getElementById('globalPlaceholderSwitch');

    const formKeyInput  = document.getElementById('formKeyInput');

    function getCurrentFormKey() {
        return (formKeyInput?.value?.trim() || 'default');
    }

    let editId = null;

    function normalizeOptionsToArray(raw) {
        if (Array.isArray(raw)) return raw;
        if (typeof raw !== 'string') return [];
        const s = raw.trim();
        if (!s) return [];
        if (s.startsWith('[') && s.endsWith(']')) {
            try {
                const arr = JSON.parse(s);
                return Array.isArray(arr) ? arr : [];
            } catch(e) {}
        }
        return s.replace(/\r\n/g, '\n')
                .split('\n')
                .map(v => v.trim())
                .filter(v => v.length);
    }
    function prettyOptions(raw) {
        return normalizeOptionsToArray(raw).join(', ');
    }

    // ✅ Automatikus betöltés
    loadFields();

    function loadFields() {
        Craft.sendActionRequest('POST', 'dwiki-form2/default/get-all', { data: { formKey: getCurrentFormKey() } })
            .then(res => {
                if (res.data.success) {
                    renderTable(res.data.fields);
                } else {
                    Craft.cp.displayError("❌ Nem sikerült betölteni a mezőket");
                }
            })
            .catch(() => {
                Craft.cp.displayError("❌ Hiba történt a mezők lekérdezésénél");
            });
    }

    // ▼▼▼ Gyorslista frissítő (AJAX) – datalist + panel ▼▼▼
    window.dwikiRefreshFormKeys = function () {
      const currentKey = document.getElementById('formKeyInput')?.value || 'default';

      Craft.sendActionRequest('POST', 'dwiki-form2/default/get-form-keys', { data: { formKey: currentKey } })
        .then(res => {
          const items = res.data.items || [];
          const panel = document.getElementById('formKeysPanel');
          const dl    = document.getElementById('formKeyList');

          if (dl) {
            dl.innerHTML = items.map(it => `<option value="${it.formKey}">`).join('');
          }

if (panel) {
  const siteHandle = panel.dataset.siteHandle || '';
  if (!items.length) {
    panel.innerHTML = '<strong>Gyors űrlapválasztó:</strong> <em>Még nincs egyetlen űrlap sem.</em>';
  } else {
    const base = window.location.pathname;
    const lis = items.map(it => {
      const url = `${base}?site=${encodeURIComponent(siteHandle)}&formKey=${encodeURIComponent(it.formKey)}`;
      return `<li><a href="${url}" title="Betöltés: ${it.formKey}">${it.formKey} <span class="light">(${it.count})</span></a></li>`;
    }).join('');
    panel.innerHTML = `<strong>Gyors űrlapválasztó:</strong><ul style="margin:6px 0 0 18px;list-style:disc;">${lis}</ul>`;
  }

  // ⬇️ Ha az aktuális űrlap már bekerült (count>0), tüntessük el a "még üres" jelzést
  const hint = document.getElementById('currentFormHint');
  if (hint) {
    const hasCurrent = items.some(it => String(it.formKey) === String(currentKey) && parseInt(it.count, 10) > 0);
    if (hasCurrent) {
      hint.remove(); // vagy: hint.style.display = 'none';
    }
  }
}
})
.catch(() => Craft.cp.displayError('Nem sikerült frissíteni az űrlap listát.'));
}; // ← window.dwikiRefreshFormKeys vége

    addBtn.addEventListener('click', () => {
        editId = null;
        fieldLabel.value = '';
        fieldType.value = 'text';
        fieldWidth.value = 'w-full';
        fieldRequired.checked = false;
        optionsWrapper.style.display = 'none';
        optionsList.innerHTML = '';
        modal.style.display = 'flex';
    });

    cancelBtn.addEventListener('click', () => modal.style.display = 'none');

    fieldType.addEventListener('change', () => {
        optionsList.innerHTML = '';
        addOptionBtn.style.display = 'none';
        if (fieldType.value === 'select') {
            optionsWrapper.style.display = 'block';
            addOptionBtn.style.display = 'inline-block';
            optionsWrapper.querySelector('label').textContent = 'Opciók:';
        } else if (fieldType.value === 'static') {
            optionsWrapper.style.display = 'block';
            optionsWrapper.querySelector('label').textContent = 'Szöveg:';
            const textarea = document.createElement('textarea');
            textarea.style.minHeight = '80px';
            textarea.value = '';
            optionsList.appendChild(textarea);
        } else {
            optionsWrapper.style.display = 'none';
        }
    });

    addOptionBtn.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Opció';
        optionsList.appendChild(input);
    });

    placeholderSwitch?.addEventListener('change', () => {
        const enabled = placeholderSwitch.checked;
        Craft.sendActionRequest('POST', 'dwiki-form2/default/save-placeholder-mode', { data: { enabled } })
            .then(res => res.data.success
                ? Craft.cp.displayNotice('Placeholder mód frissítve.')
                : Craft.cp.displayError('Hiba a mentésnél.'))
            .catch(() => Craft.cp.displayError('Hiba a mentésnél.'));
    });

    saveBtn.addEventListener('click', () => {
        const label = fieldLabel.value.trim();
        const type = fieldType.value;
        const width = fieldWidth.value;
        const required = fieldRequired.checked ? 1 : 0;
        let options = '';

        if (type === 'select') {
            options = Array.from(optionsList.querySelectorAll('input'))
                .map(i => i.value.trim())
                .filter(v => v)
                .join("\n");
        } else if (type === 'static') {
            const textarea = optionsList.querySelector('textarea');
            options = textarea ? textarea.value : '';
        }

        Craft.sendActionRequest('POST', 'dwiki-form2/default/save', {
            data: { id: editId, label, type, width, options, required, formKey: getCurrentFormKey() }
        }).then(res => {
            if (res.data.success) {
                renderTable(res.data.fields);
                modal.style.display = 'none';
                Craft.cp.displayNotice('Mező mentve.');
                // ⬇️ új/első mező után azonnal frissítsük a gyorslistát
                dwikiRefreshFormKeys();

                    // ⬇️ ÚJ: ha már van legalább 1 mező, tüntessük el a "még üres" jelzést AZONNAL
                    const hintEl = document.getElementById('currentFormHint');
                    if (hintEl && Array.isArray(res.data.fields) && res.data.fields.length > 0) {
                        hintEl.remove();
                    }
            } else {
                Craft.cp.displayError('Hiba a mentésnél.');
            }
        }).catch(() => Craft.cp.displayError('Hiba a mentésnél.'));
    });

    fieldsBody.addEventListener('click', function(e) {
        const row = e.target.closest('tr');
        const id = row ? row.getAttribute('data-id') : null;

        if (e.target.classList.contains('deleteBtn')) {
            if (!confirm('Biztosan törlöd?')) return;
            Craft.sendActionRequest('POST', 'dwiki-form2/default/delete', { data: { id, formKey: getCurrentFormKey() } })
                .then(res => {
                    if (res.data.success) {
                        renderTable(res.data.fields);
                        Craft.cp.displayNotice('Mező törölve.');
                        // ⬇️ törlés után is frissítjük a gyorslistát
                        dwikiRefreshFormKeys();
                    } else {
                        Craft.cp.displayError('Hiba a törlésnél.');
                    }
                }).catch(() => Craft.cp.displayError('Hiba a törlésnél.'));
            return;
        }

        if (e.target.classList.contains('editBtn')) {
            Craft.sendActionRequest('POST', 'dwiki-form2/default/get', { data: { id, formKey: getCurrentFormKey() } })
                .then(res => {
                    if (res.data.success && res.data.field) {
                        const f = res.data.field;
                        editId = f.id;
                        fieldLabel.value = f.label;
                        fieldType.value = f.type;
                        fieldWidth.value = f.width || 'w-full';
                        fieldRequired.checked = !!f.required;

                        optionsList.innerHTML = '';
                        addOptionBtn.style.display = 'none';

                        if (f.type === 'select') {
                            optionsWrapper.style.display = 'block';
                            addOptionBtn.style.display = 'inline-block';
                            optionsWrapper.querySelector('label').textContent = 'Opciók:';

                            const opts = normalizeOptionsToArray(f.options);
                            if (opts.length === 0) opts.push('');
                            opts.forEach(opt => {
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.value = opt;
                                optionsList.appendChild(input);
                            });
                        } else if (f.type === 'static') {
                            optionsWrapper.style.display = 'block';
                            optionsWrapper.querySelector('label').textContent = 'Szöveg:';
                            const textarea = document.createElement('textarea');
                            textarea.style.minHeight = '80px';
                            textarea.value = (typeof f.options === 'string') ? f.options : '';
                            optionsList.appendChild(textarea);
                        } else {
                            optionsWrapper.style.display = 'none';
                        }

                        modal.style.display = 'flex';
                    } else {
                        Craft.cp.displayError('Hiba a mező betöltésekor.');
                    }
                }).catch(() => Craft.cp.displayError('Hiba a mező betöltésekor.'));
        }
    });

    let draggedRow = null;
    fieldsBody.addEventListener('dragstart', function(e) {
        draggedRow = e.target.closest('tr');
        e.dataTransfer.effectAllowed = 'move';
    });
    fieldsBody.addEventListener('dragover', function(e) {
        e.preventDefault();
        const targetRow = e.target.closest('tr');
        if (targetRow && targetRow !== draggedRow) {
            const rect = targetRow.getBoundingClientRect();
            const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
            fieldsBody.insertBefore(draggedRow, next ? targetRow.nextSibling : targetRow);
        }
    });
    fieldsBody.addEventListener('drop', function() {
        const order = Array.from(fieldsBody.querySelectorAll('tr')).map(tr => tr.getAttribute('data-id'));
        Craft.sendActionRequest('POST', 'dwiki-form2/default/update-order', { data: { order, formKey: getCurrentFormKey() } })
            .then(res => res.data.success ? (Craft.cp.displayNotice('Sorrend frissítve.'), dwikiRefreshFormKeys())
                                          : Craft.cp.displayError('Hiba a sorrend mentésénél.'))
            .catch(() => Craft.cp.displayError('Hiba a sorrend mentésénél.'));
    });

    function renderTable(fields) {
        fieldsBody.innerHTML = '';

        const hasFields = Array.isArray(fields) && fields.length > 0;
        if (!hasFields) {
            fieldsBody.innerHTML = '<tr><td colspan="6"><em>Nincs még mező.</em></td></tr>';
            return;
        }

        // Sorok összerakása
        const rows = fields.map(f => {
            const optionsStr = prettyOptions(f.options);
            return `
                <tr data-id="${f.id}" draggable="true">
                    <td>${f.label}</td>
                    <td>${f.type}</td>
                    <td>${optionsStr}</td>
                    <td>${f.width || ''}</td>
                    <td>${f.required ? '✔️' : ''}</td>
                    <td>
                        <span class="moveIcon" style="cursor:grab;">☰</span>
                        <button type="button" class="btn small editBtn">Szerkesztés</button>
                        <button type="button" class="btn small deleteBtn">Törlés</button>
                    </td>
                </tr>
            `;
        }).join('');

        fieldsBody.innerHTML = rows;

        // ⬇️ Van már mező → tüntessük el a "még üres" jelzést (ha létezik)
        const hint = document.getElementById('currentFormHint');
        if (hint) {
            hint.remove(); // vagy: hint.style.display = 'none';
        }
    }
});
</script>

{% endblock %}
